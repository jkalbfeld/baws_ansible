- name: "including vars file"
  include_vars: "{{ansible_os_family}}.yml"

- name: including apache task file
  include: "{{ansible_os_family}}.yml"


#Activate volume, if attached.
#This doesn't detect "mounted" specifically, for easy local environment
#replication.
- block:
  - name: stat app drive
    stat: path=/www
    register: appdrive

  - name: sym apache volume
    file:
     src: /etc/httpd/sites-available/volumes/www.conf
     dest: /etc/httpd/sites-enabled/www.conf
     state: link
    when: appdrive.stat.exists

  tags:
   - webdav
   - apache

#Clone configuration.
- block:
  - name: stat apache git repo
    stat: path={{apache_dir}}/.git
    register: apache_repo

  - name: clear apache directory
    file: path={{apache_dir}} state=absent
    when: not apache_repo.stat.exists

  - name: clone apache config
    git:
      repo: https://github.com/wwwpro/httpd.git
      dest: "{{apache_dir}}"
    when: not apache_repo.stat.exists

  tags:
   - webdav

- name: check for bb apache config
  stat: path={{apache_dir}}/.git
  register: apache_default
  tags:
   - always

- name: remove current default if exists
  file: name={{apache_dir}}/sites-available

- name: create default site conf
  template: src=default-dav.conf.j2 dest={{apache_dir}}/sites-available/default-dav.conf

- name: symlinking default webdav
  file:
    src: /etc/httpd/sites-enabled/burris_builder-dav.conf
    dest: /etc/httpd/sites-available/burris_builder-dav.conf
    state: link
  when: apache_default.stat.exists
  tags:
   - builder_dev